<!DOCTYPE html>
<html>
  <head>
    <title>EComm</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

     <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
  </head>

  <body>
    <!-- Nav--> 
    <%= render 'layouts/store/nav' %>
    <!-- Header-->    
    <%= render 'layouts/store/header' %>
    <%= yield %>
     <!-- Footer--> 
    <%= render 'layouts/store/footer' %>
  </body>

  <script>

    fetch('/products_api')
.then(response => response.json())
.then(function(data){
    localStorage.setItem("products", JSON.stringify(data));
    if(!localStorage.getItem("cart")){
        localStorage.setItem("cart", JSON.stringify([]));
    } else {
    console.error('A resposta da API está vazia ou nula.');
  }
});

//GLOGALS

let products = JSON.parse(localStorage.getItem("products")) !== null ? JSON.parse(localStorage.getItem("products")) : [];
let cart = JSON.parse(localStorage.getItem("cart")) !== null ? JSON.parse(localStorage.getItem("cart")) : [];



function addItemToCart(productId) {
    if (products) {
        let product = products.find(function(product) {
            return product.id == productId;
        });

        
        if (!cart.some(item => item.id === productId)) {
            cart.push({"id": productId, "qt": 1});
            localStorage.setItem("cart", JSON.stringify(cart));
            console.log('Produto adicionado ao carrinho.');
        } else if (cart.some(item => item.id === productId)) {
            let existingItem = cart.find(item => item.id === productId);
            existingItem.qt += 1;
            localStorage.setItem("cart", JSON.stringify(cart));
            console.log('Quantidade adicionado ao carrinho.');
        } else {
            console.log('Produto já está no carrinho.');
        }
        
    } else {
        console.error('Lista de produtos não carregada.');
    }
}



function removeItemToCart(productId){
    let temp = cart.filter(item => item.id != productId);
    localStorage.setItem("cart", JSON.stringify(temp));
}




function updateQuantity(productId, quantity){
    for(let product of cart){
        if(product.id == productId){
            product.qt = quantity;
        }
    }
    localStorage.setItem("cart", JSON.stringify(cart));
}



function getTotal(){
    let temp = cart.map(function(item){
        return parseFloat(item.price);
    });

    let sum = temp.reduce(function(prev, next){
        return prev + next;
    }, 0);
}


  </script>
</html>
